# nav2_multi.yaml  （robot番号は記載しない）

controller_server:
    ros__parameters:
      controller_frequency: 15.0
      use_sim_time: true

      amcl:
        ros__parameters:
          use_sim_time: true
          odom_frame_id: "odom"

      # ★回頭中に「進んでない」と誤判定しないよう猶予を伸ばす
      progress_checker:
        plugin: "nav2_controller::SimpleProgressChecker"
        required_movement_radius: 0.02       # 並進しなくてもOKに近い数値
        movement_time_allowance: 15.0        # その場回転の最中に fail させない

      # ★ゴール判定：姿勢もきちんと合わせたいなら少しタイトに
      goal_checker:
        plugin: "nav2_controller::SimpleGoalChecker"
        xy_goal_tolerance: 0.20              # 0.20〜0.30 の範囲でOK
        yaw_goal_tolerance: 0.20             # ≈11.5°（揃えたいなら 0.15 まで可）
        stateful: false

      # ★ローカルプランナ（RPP前提）
      controller_plugins: ["FollowPath"]
      FollowPath:
        plugin: "nav2_regulated_pure_pursuit_controller::RegulatedPurePursuitController"

        # 基本速度
        desired_linear_vel: 0.35
        max_linear_accel: 2.0
        max_linear_decel: 2.0
        max_angular_vel: 2.0                 # 回頭を力強く

        # 追従パラメータ
        lookahead_dist: 0.6
        min_lookahead_dist: 0.3
        max_lookahead_dist: 0.8
        lookahead_time: 1.5
        use_velocity_scaled_lookahead_dist: true
        transform_tolerance: 0.2

        # ★到着後の回頭を必ず実行
        use_rotate_to_goal: true
        rotate_to_goal_threshold: 0.35        # ≈20°以上ズレてたら回頭モード突入
        rotate_to_heading_angular_vel: 1.2    # その場回転の角速度
        min_approach_linear_velocity: 0.02    # ゴール接近時はゆっくり
        allow_reversing: false

        # 近傍減速が強すぎて止まるのを防ぐ
        regulated_linear_scaling_min_radius: 0.8
        regulated_linear_scaling_min_speed: 0.05
        inflation_cost_scaling_factor: 2.5

local_costmap:
    local_costmap:
      ros__parameters:
        use_sim_time: true
        global_frame: "<ns>/odom"
        robot_base_frame: "<ns>/base_link"
        update_frequency: 10.0
        publish_frequency: 5.0
        rolling_window: true
        width: 6
        height: 6
        resolution: 0.05
        robot_radius: 0.20
        footprint_padding: 0.02
        transform_tolerance: 0.2

        plugins: ["obstacle_layer", "inflation_layer"]

        obstacle_layer:
          plugin: "nav2_costmap_2d::ObstacleLayer"
          enabled: true
          observation_sources: scan
          scan:
            topic: "<ns>/scan"
            data_type: "LaserScan"
            clearing: true
            marking: true
            max_obstacle_height: 2.0

        inflation_layer:
          plugin: "nav2_costmap_2d::InflationLayer"
          enabled: true
          inflation_radius: 0.45          # ← 広すぎると回頭できない
          cost_scaling_factor: 2.5
  
global_costmap:
  global_costmap:
    ros__parameters:
      use_sim_time: true
      update_frequency: 5.0
      publish_frequency: 2.0

      global_frame: map             # ← 共有 /map を使うならここは 'map' 固定
      robot_base_frame: base_link   # ← 相対名（NSで /<ns>/base_link）
      rolling_window: false
      track_unknown_space: true
      resolution: 0.05

      plugins: ["static_layer","obstacle_layer","inflation_layer"]
      static_layer:
        plugin: "nav2_costmap_2d::StaticLayer"
        map_subscribe_transient_local: true
        map_topic: /map             # ← 共有 /map を購読（絶対名）
        subscribe_to_updates: false
      obstacle_layer:
        plugin: "nav2_costmap_2d::ObstacleLayer"
        enabled: false              # ← 初回はOFFでもOK（動作確認優先）
        observation_sources: ""
      inflation_layer:
        plugin: "nav2_costmap_2d::InflationLayer"
        enabled: true
        inflation_radius: 0.8
        cost_scaling_factor: 3.0

planner_server:
    ros__parameters:
      planner_plugins: ["GridBased"]
      GridBased:
        plugin: "nav2_navfn_planner/NavfnPlanner"
        tolerance: 0.5         # 0.3〜0.7 で調整
        allow_unknown: true
        use_astar: false
  
behavior_server:
  ros__parameters:
    use_sim_time: true
    cycle_frequency: 10.0
    transform_tolerance: 0.3
    simulate_ahead_time: 2.0
    enable_stamped_cmd_vel: false
    behavior_plugins: ["spin","backup","drive_on_heading","wait"]
    spin:
      plugin: "nav2_behaviors/Spin"
    backup:
      plugin: "nav2_behaviors/BackUp"
    drive_on_heading:
      plugin: "nav2_behaviors/DriveOnHeading"
    wait:
      plugin: "nav2_behaviors/Wait"

bt_navigator:
  ros__parameters:
    use_sim_time: true
    global_frame: map
    robot_base_frame: base_link     # ← 相対名（NSで /<ns>/base_link）
    # BT XML は launch 側で解決＆上書き推奨
    plugin_lib_names:
      - nav2_compute_path_to_pose_action_bt_node
      - nav2_follow_path_action_bt_node
      - nav2_back_up_action_bt_node
      - nav2_spin_action_bt_node
      - nav2_wait_action_bt_node
      - nav2_clear_costmap_service_bt_node
      - nav2_is_path_valid_condition_bt_node
      - nav2_goal_reached_condition_bt_node
      - nav2_initial_pose_received_condition_bt_node
      - nav2_goal_updated_condition_bt_node
      - nav2_recovery_node_bt_node
      - nav2_pipeline_sequence_bt_node
      - nav2_rate_controller_bt_node
