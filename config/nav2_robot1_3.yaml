# Nav2 in namespace (e.g., namespace:=robot1) but map topic is global "/map".
# ※ ノード名は素のまま(amcl, map_server 等)。YAML内に /robot1/… を書かないこと。

amcl:
  ros__parameters:
    use_sim_time: true
    # === Frames (ネームスペースは付けない) ===
    base_frame_id: base_link
    odom_frame_id: odom
    global_frame_id: map

    # === Topics ===
    scan_topic: scan       # 相対名 -> <ns>/scan を購読
    map_topic: /map        # 絶対名 -> グローバル /map を購読

    # AMCL 代表パラメータ（必要に応じて調整）
    alpha1: 0.2
    alpha2: 0.2
    alpha3: 0.2
    alpha4: 0.2
    alpha5: 0.2
    tf_broadcast: true
    update_min_d: 0.05
    update_min_a: 0.05
    resample_interval: 1
    transform_tolerance: 1.0
    laser_max_beams: 60
    laser_min_range: 0.0
    laser_max_range: 30.0
    set_initial_pose: false
    always_reset_initial_pose: false

map_server:
  ros__parameters:
    use_sim_time: true
    # bringup_launch.py の map:= で渡すため yaml_filename は省略可
    # yaml_filename: /home/USER/ROS2ForUnity_ws/my_unity_map_2.yaml

    # /map を「絶対名」で配信（常にグローバル）
    topic_name: /map
    # map メッセージの frame_id（TFが map-odom-base_link である前提）
    frame_id: map

planner_server:
  ros__parameters:
    use_sim_time: true
    expected_planner_frequency: 20.0
    planner_plugins: ["GridBased"]
    GridBased:
      plugin: "nav2_navfn_planner/NavfnPlanner"
      tolerance: 0.5

controller_server:
  ros__parameters:
    use_sim_time: true
    controller_frequency: 20.0
    progress_checker:
      plugin: "nav2_controller::SimpleProgressChecker"
    goal_checker:
      plugin: "nav2_controller::SimpleGoalChecker"
      xy_goal_tolerance: 0.25
      yaw_goal_tolerance: 0.25
    controller_plugins: ["FollowPath"]
    FollowPath:
      plugin: "dwb_core::DWBLocalPlanner"
      debug_trajectory_details: false

smoother_server:
  ros__parameters:
    use_sim_time: true
    smoother_plugins: ["simple_smoother"]
    simple_smoother:
      plugin: "nav2_smoother::SimpleSmoother"

behavior_server:
  ros__parameters:
    use_sim_time: true
    behavior_plugins: ["spin", "backup", "drive_on_heading", "wait"]
    spin:
      plugin: "nav2_behaviors/Spin"
    backup:
      plugin: "nav2_behaviors/BackUp"
    drive_on_heading:
      plugin: "nav2_behaviors/DriveOnHeading"
    wait:
      plugin: "nav2_behaviors/Wait"

bt_navigator:
  ros__parameters:
    use_sim_time: true
    default_nav_to_pose_bt_xml: "navigate_w_replanning_and_recovery.xml"

waypoint_follower:
  ros__parameters:
    use_sim_time: true
    default_behaviors: ["wait_at_waypoint"]
    wait_at_waypoint:
      plugin: "nav2_waypoint_follower::WaitAtWaypoint"

velocity_smoother:
  ros__parameters:
    use_sim_time: true

# === Global Costmap ===
# フレームは map / base_link、地図は絶対名 /map を購読
global_costmap:
  global_costmap:
    ros__parameters:
      use_sim_time: true
      global_frame: map
      robot_base_frame: base_link
      rolling_window: false
      update_frequency: 5.0
      publish_frequency: 2.0
      resolution: 0.05
      track_unknown_space: true
      always_send_full_costmap: true
      plugins: ["static_layer", "obstacle_layer", "inflation_layer"]

      static_layer:
        plugin: "nav2_costmap_2d::StaticLayer"
        map_topic: /map                    # 絶対名（グローバル）
        subscribe_to_updates: false
        map_subscribe_transient_local: true

      obstacle_layer:
        plugin: "nav2_costmap_2d::ObstacleLayer"
        observation_sources: scan
        scan:
          topic: scan                      # 相対名 -> <ns>/scan を購読
          max_obstacle_height: 2.0
          clearing: true
          marking: true
          data_type: "LaserScan"

      inflation_layer:
        plugin: "nav2_costmap_2d::InflationLayer"
        inflation_radius: 0.55
        cost_scaling_factor: 10.0

# === Local Costmap ===
# フレームは odom / base_link、scan は <ns>/scan
local_costmap:
  local_costmap:
    ros__parameters:
      use_sim_time: true
      global_frame: odom
      robot_base_frame: base_link
      rolling_window: true
      width: 10.0
      height: 10.0
      resolution: 0.05
      update_frequency: 10.0
      publish_frequency: 5.0
      always_send_full_costmap: true
      plugins: ["voxel_layer", "inflation_layer"]

      voxel_layer:
        plugin: "nav2_costmap_2d::VoxelLayer"
        z_voxels: 2
        z_resolution: 0.2
        max_obstacle_height: 2.0
        observation_sources: scan
        scan:
          topic: scan                      # 相対名 -> <ns>/scan
          max_obstacle_height: 2.0
          clearing: true
          marking: true
          data_type: "LaserScan"

      inflation_layer:
        plugin: "nav2_costmap_2d::InflationLayer"
        inflation_radius: 0.55
        cost_scaling_factor: 10.0

lifecycle_manager_localization:
  ros__parameters:
    use_sim_time: true
    node_names: ["map_server", "amcl"]
    autostart: true
    bond_timeout: 0.0

lifecycle_manager_navigation:
  ros__parameters:
    use_sim_time: true
    node_names: ["controller_server", "smoother_server", "planner_server",
                 "behavior_server", "bt_navigator", "waypoint_follower", "velocity_smoother"]
    autostart: true
    bond_timeout: 0.0
